/**
 * ---------------------------------------------------------------------
 *
 * GLPI - Gestionnaire Libre de Parc Informatique
 *
 * http://glpi-project.org
 *
 * @copyright 2015-2025 Teclib' and contributors.
 * @copyright 2003-2014 by the INDEPNET Development Team.
 * @licence   https://www.gnu.org/licenses/gpl-3.0.html
 *
 * ---------------------------------------------------------------------
 *
 * LICENSE
 *
 * This file is part of GLPI.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 *
 * ---------------------------------------------------------------------
 */
var current_page=1;var ajax_url;var ajax_done=false;$(document).ready(function(){ajax_url=`${CFG_GLPI.root_doc}/ajax/marketplace.php`;$(document).on("click",".marketplace .modify_plugin",function(){var e=$(this);var a=e.closest(".buttons");var t=e.closest("li.plugin");var i=e.children("i");var n=e.closest(".marketplace").hasClass("installed");var r=e.data("action");var l=t.data("key");var s=t.data("state");i.removeClass().addClass("spinner-border");const o=function(){if(r==="download_plugin"||r==="update_plugin"){followDownloadProgress(e)}ajax_done=false;$.post(ajax_url,{action:r,key:l}).done(function(e){ajax_done=true;if(e.indexOf("cleaned")!==-1&&n){t.remove()}else{e=e.replace("cleaned","");a.html(e);displayAjaxMessageAfterRedirect();addTooltips()}})};if((r==="download_plugin"||r==="update_plugin")&&(s==="activated"||s==="tobeconfigured")){$.post(ajax_url,{action:"disable_plugin",key:l}).done(function(){o()});return}else{o()}});$(document).on("select2:select",".marketplace .sort-control",function(){filterPluginList()});$(document).on("click",".marketplace .pagination li",function(){var e=$(this);var a=e.data("page");if(e.hasClass("nav-disabled")||e.hasClass("current")||isNaN(a)){return}refreshPlugins(a)});$(document).on("click",".marketplace .plugins-tags .tag",function(){$(".marketplace:visible .plugins-tags .tag").removeClass("active");$(this).addClass("active");filterPluginList()});var e;$(document).on("input",".marketplace .filter-list",function(){clearTimeout(e);e=setTimeout(function(){filterPluginList()},500)});$(document).on("click",".marketplace .refresh-plugin-list",function(){refreshPlugins(current_page,true)})});var filterPluginList=function(e,a){e=e||1;a=a||false;var t=$(".marketplace:visible");var i=t.find("ul.pagination");var n=t.find("ul.plugins");var r=t.find(".plugins-tags .tag.active");var l=r.length?r.data("tag"):"";var s=t.find(".filter-list").val();var o="sort-alpha-desc";if(t.find(".sort-control").length>0){o=t.find(".sort-control").select2("data")[0].element.value}n.append("<div class='loading-plugins'><div class='spinner-border'></div></div>");i.find("li.current").removeClass("current");var c=$.get(ajax_url,{action:"refresh_plugin_list",tab:t.data("tab"),tag:l,filter:s,force:a?1:0,page:e,sort:o}).done(function(a){n.html(a);if(t.data("tab")==="installed"){return}var r=c.getResponseHeader("X-GLPI-Marketplace-Total");$.get(ajax_url,{action:"getPagination",page:e,total:r}).done(function(e){i.html(e)})});return c};var refreshPlugins=function(e,a){a=a||false;var t=$(".marketplace:visible .refresh-plugin-list");t.removeClass("ti ti-refresh").addClass("spinner-border spinner-border-sm");$.when(filterPluginList(e,a)).then(function(){t.removeClass("spinner-border spinner-border-sm").addClass("ti ti-refresh");current_page=e;addTooltips()})};var addTooltips=function(){$(".qtip").remove();$(".marketplace:visible").find("[data-action][title], .add_tooltip").qtip({position:{viewport:$(window),my:"center left",at:"center right",adjust:{x:2,method:"flip"}},style:{classes:"qtip-dark"},show:{solo:true},hide:{event:"click mouseleave"}})};var followDownloadProgress=function(e){var a=e.closest(".buttons");var t=e.closest("li.plugin");var i=t.data("key");var n=$('<progress max="100" value="0"></progress>');a.html(n);function r(){setTimeout(function(){$.get(ajax_url,{action:"get_dl_progress",key:i}).done(function(e){n.attr("value",e);if(e<100){r()}else if(!ajax_done){a.html('<i class="fas fa-cog fa-spin"></i>');displayAjaxMessageAfterRedirect()}})},300)}r()};
/**
 * ---------------------------------------------------------------------
 *
 * GLPI - Gestionnaire Libre de Parc Informatique
 *
 * http://glpi-project.org
 *
 * @copyright 2015-2025 Teclib' and contributors.
 * @copyright 2003-2014 by the INDEPNET Development Team.
 * @licence   https://www.gnu.org/licenses/gpl-3.0.html
 *
 * ---------------------------------------------------------------------
 *
 * LICENSE
 *
 * This file is part of GLPI.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 *
 * ---------------------------------------------------------------------
 */
window.GLPI=window.GLPI||{};window.GLPI.RichText=window.GLPI.RichText||{};window.GLPI.RichText.UserMention=class{constructor(t,e,i,n){this.editor=t;this.activeEntity=e;this.idorToken=i;this.mentionsOptions=n}register(){this.editor.ui.registry.addAutocompleter("user_mention",{trigger:"@",minChars:0,fetch:t=>this.fetchItems(t),onAction:(t,e,i)=>{this.mentionUser(t,e,i)}})}fetchItems(t){return new Promise(e=>{$.post(`${CFG_GLPI.root_doc}/ajax/getDropdownUsers.php`,{entity_restrict:this.activeEntity,right:"all",display_emptychoice:0,searchText:t,_idor_token:this.idorToken}).then(t=>{let i=t.results;if(!this.mentionsOptions.full){const t=this.mentionsOptions.users;i=i.filter(e=>t.includes(e.id))}const n=i.map(t=>({type:"autocompleteitem",value:JSON.stringify({id:t.id,name:t.text}),text:t.text}));e(n)})})}mentionUser(t,e,i){const n=JSON.parse(i);this.editor.selection.setRng(e);this.editor.insertContent(this.generateUserMentionHtml(n));t.hide()}generateUserMentionHtml(t){return`<span contenteditable="false"\n                    data-user-mention="true"\n                    data-user-id="${_.escape(t.id)}">@${_.escape(t.name)}</span>&nbsp;`}};
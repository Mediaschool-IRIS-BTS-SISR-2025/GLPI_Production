/**
 * ---------------------------------------------------------------------
 *
 * GLPI - Gestionnaire Libre de Parc Informatique
 *
 * http://glpi-project.org
 *
 * @copyright 2015-2025 Teclib' and contributors.
 * @copyright 2003-2014 by the INDEPNET Development Team.
 * @licence   https://www.gnu.org/licenses/gpl-3.0.html
 *
 * ---------------------------------------------------------------------
 *
 * LICENSE
 *
 * This file is part of GLPI.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 *
 * ---------------------------------------------------------------------
 */
var insertIntoEditor=[];var uploaded_images=[];function uploadFile(e,t){insertIntoEditor[e.name]=isImage(e);var a=$(`[data-uploader-name="${CSS.escape(t.getElement().name)}"]`);if(a.length===0){a=$(t.getElement()).closest("form").find('[data-uploader-name="filename"]')}if(a.length===0){a=$(t.getElement()).closest("form").find("[data-uploader-name=]").first()}a.fileupload("add",{files:[e]})}var handleUploadedFile=function(e,t,a,n,o){$.ajax({type:"POST",url:`${CFG_GLPI.root_doc}/ajax/getFileTag.php`,data:{data:t},dataType:"JSON",success:function(i){$.each(e,(e,d)=>{if(t[e].error!==undefined){n.parent().find(".uploadbar").text(t[e].error).css("width","100%");return}var r=i[e];var l=null;if(o){l=tinyMCE.get(o);const e=uploaded_images.find(e=>e.filename===d.name);const t=e!==undefined?l.dom.select(`img[data-upload_id="${CSS.escape(e.upload_id)}"]`):[];if(t.length>0){l.dom.setAttrib(t,"id",r.tag.replace(/#/g,""))}}displayUploadedFile(t[e],r,l,a,n);n.parent().find(".uploadbar").text(__("Upload successful")).css("width","100%").delay(2e3).fadeOut("slow")})},error:function(e){console.warn(e.responseText)},complete:function(){$.each(e,(e,t)=>{delete insertIntoEditor[t.name]})}})};var displayUploadedFile=function(e,t,a,n,o){var i=$(`input[name^="_${CSS.escape(n)}["]`).length;var d=e.name.split(".").pop();var r=$("<p></p>").attr("id",e.id).html(`${getExtIcon(d)}&nbsp;<b>${_.escape(e.display)}</b>&nbsp;(${getSize(e.size)})&nbsp;`).appendTo(o);$("<input/>").attr("type","hidden").attr("name",`_${n}[${i}]`).attr("value",e.name).appendTo(r);$("<input/>").attr("type","hidden").attr("name",`_prefix_${n}[${i}]`).attr("value",e.prefix).appendTo(r);$("<input/>").attr("type","hidden").attr("name",`_tag_${n}[${i}]`).attr("value",t.name).appendTo(r);var l={0:e.id,1:`${e.id}2`};$('<span class="ti ti-circle-x pointer remove_file_upload"></span>').on("click",()=>{deleteImagePasted(l,t.tag,a);$(document).trigger("glpi_fileupload_remove",{elementsIdToRemove:l,tagToRemove:t.tag,editor:a})}).appendTo(r)};var deleteImagePasted=function(e,t,a){$.each(e,(e,t)=>{$(`#${CSS.escape(t)}`).remove()});if(typeof a!=="undefined"&&a!==null&&typeof a.dom!=="undefined"){var n=new RegExp("#","g");a.dom.remove(t.replace(n,""))}};const setRichTextEditorContent=function(e,t){if(typeof tinyMCE==="undefined"){return}const a=tinyMCE.get(e);if(a){a.setContent("");a.execCommand("mceInsertClipboardContent",false,{html:t,internal:true});a.fire("keyup")}};if(typeof tinyMCE!="undefined"){tinyMCE.PluginManager.add("glpi_upload_doc",e=>{let t=null;const a={pngblip:"image/png",jpegblip:"image/jpeg"};e.on("paste",e=>{t=e.clipboardData});e.on("PastePreProcess",n=>{const o=[];if(t!==null&&t.types.includes("text/rtf")){const e=t.getData("text/rtf");const n=e.replace(/(\r\n|\n|\r)/gm,"");const i=n.matchAll(/\\(pngblip|jpegblip)([a-z0-9]*)}/g);for(const e of i){const t=e[1];const n=e[2];const i=e=>btoa(e.match(/\w{2}/g).map(e=>String.fromCharCode(parseInt(e,16))).join(""));o.push({type:a[t],content:i(n)})}}var i=$("<div></div>");i.append(n.content);i.find("img").each(function(){const t=$(this);let a=t.attr("src");const n="^file://";if(a.match(n)!==null&&o.length>0){const e=o.shift();a=`data:${e["type"]};base64,${e["content"]}`;t.attr("src",a)}if(a.match(new RegExp("^(data|blob):"))!==null){const n=Math.random().toString();t.attr("data-upload_id",n);fetch(a).then(e=>e.blob()).then(t=>{if(/^image\/.+/.test(t.type)===false){return}if(t instanceof File){t=new Blob([t],{type:t.type})}const a=t.type.replace("image/","");t.name=`image_paste${Math.floor(Math.random()*1e7+1)}.${a}`;uploaded_images.push({upload_id:n,filename:t.name});uploadFile(t,e)})}});n.content=i.html()})})}$(()=>{$(document).bind("dragover",e=>{e.preventDefault();var t=$(".dropzone");var a;var n=window.dropZoneTimeout;if(!n){t.addClass("dragin")}else{clearTimeout(n)}var o=false;var i=e.target;do{if($(i).hasClass("draghoverable")){o=true;a=$(i);break}i=i.parentNode}while(i!==null);t.removeClass("dragin draghover");if(o){a.addClass("draghover")}});$(document).bind("drop",e=>{e.preventDefault();$(".draghoverable").removeClass("draghover")})});
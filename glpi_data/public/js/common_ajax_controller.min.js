/**
 * ---------------------------------------------------------------------
 *
 * GLPI - Gestionnaire Libre de Parc Informatique
 *
 * http://glpi-project.org
 *
 * @copyright 2015-2025 Teclib' and contributors.
 * @copyright 2003-2014 by the INDEPNET Development Team.
 * @licence   https://www.gnu.org/licenses/gpl-3.0.html
 *
 * ---------------------------------------------------------------------
 *
 * LICENSE
 *
 * This file is part of GLPI.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 *
 * ---------------------------------------------------------------------
 */
class GlpiCommonAjaxController{constructor(){$(document).on("submit","form[data-ajax-submit]",e=>this.#e(e))}async#e(e){e.preventDefault();const t=$(e.target).closest("form");const n=this.#t(t);try{const e=await $.ajax({url:`${CFG_GLPI.root_doc}/GenericAjaxCrud`,method:"POST",contentType:"application/json",data:n});this.#n(e);this.#a(e);this.#s(e,t);this.#r(e);this.#i();t.trigger("glpi-ajax-controller-submit-success",e)}catch(e){if(e.responseJSON!==undefined&&e.responseJSON.messages!==undefined){this.#n(e.responseJSON)}else{console.error(e);this.#n({messages:{error:[__("Unexpected error.")]}})}}}#t(e){const t=document.activeElement;let n=null;if(t.tagName.toLowerCase()=="button"||t.tagName.toLowerCase()=="input"&&($(t).attr("type")=="submit"||$(t).attr("type")=="button")){n=$(t).prop("name")}else{n="update"}const a=new FormData(e.get(0));const s={};let r;let i;for([r,i]of a.entries()){if(i===""&&e.get(0).querySelector(`[name="${CSS.escape(r)}[]"]:not([disabled])`)){if(_.get(s,r)===undefined){_.setWith(s,r,[],Object)}continue}if(r.endsWith("[]")){const e=r.slice(0,-2);if(_.get(s,e)===undefined||!Array.isArray(_.get(s,e))){_.set(s,e,[])}_.get(s,e).push(i)}else{_.setWith(s,r,i,Object)}}s._action=n;s[n]=true;s.itemtype=e.data("ajaxSubmitItemtype");return JSON.stringify(s)}#n(e){if(!e.messages){return}if(e.messages.info!==undefined){e.messages.info.forEach(e=>glpi_toast_info(e))}if(e.messages.warning!==undefined){e.messages.warning.forEach(e=>glpi_toast_warning(e))}if(e.messages.error!==undefined){e.messages.error.forEach(e=>glpi_toast_error(e))}}#a(e){if(!e.friendlyname||!$("#header-friendlyname").length){return}$("#header-friendlyname").text(e.friendlyname)}#s(e,t){if(e.is_deleted===undefined){return}$("#navigationheader").toggleClass("asset-deleted",e.is_deleted);t.find("button[name=delete]").toggleClass("d-none",e.is_deleted);t.find("button[name=purge]").toggleClass("d-none",!e.is_deleted);t.find("button[name=restore]").toggleClass("d-none",!e.is_deleted)}#r(e){if(e.redirect===undefined){return}window.location=e.redirect}#i(){$("[data-glpi-tab-content]").each((e,t)=>{const n=$(t).hasClass("active");if(n){return}$(t).html("")})}}
/**
 * ---------------------------------------------------------------------
 *
 * GLPI - Gestionnaire Libre de Parc Informatique
 *
 * http://glpi-project.org
 *
 * @copyright 2015-2025 Teclib' and contributors.
 * @copyright 2003-2014 by the INDEPNET Development Team.
 * @licence   https://www.gnu.org/licenses/gpl-3.0.html
 *
 * ---------------------------------------------------------------------
 *
 * LICENSE
 *
 * This file is part of GLPI.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 *
 * ---------------------------------------------------------------------
 */
class GeolocationField{constructor(t){this.element_id=CSS.escape(t);this.rand=Math.floor(Math.random()*1e4);this.marker=null;this.#t()}#t(){if(!navigator.geolocation){this.map=initMap($(`#${this.element_id}`),`setlocation_${this.rand}`,"400px");this.#e()}else{navigator.geolocation.getCurrentPosition(t=>{const e=t.coords.accuracy;let a;if(e>3e3){a=10}else if(e>1e3){a=15}else if(e>500){a=17}else{a=20}this.map=initMap($(`#${this.element_id}`),`setlocation_${this.rand}`,"400px",{position:[t.coords.latitude,t.coords.longitude],zoom:a});this.#e()},()=>{this.map=initMap($(`#${this.element_id}`),`setlocation_${this.rand}`,"400px");this.#e()},{enableHighAccuracy:true})}}#e(){const t=L.Control.geocoder({defaultMarkGeocode:false,errorMessage:__("No results found"),placeholder:__("Search")});t.on("markgeocode",t=>{this._map.fitBounds(t.geocode.bbox)});this.map.addControl(t);this.#a();this.map.on("click",t=>{const e=L.popup();e.setLatLng(t.latlng).setContent("SELECTPOPUP").openOn(this.map)});this.map.on("popupopen",t=>{const e=t.popup;const a=$(e._container);const o=e._latlng.lat.toString();const i=e._latlng.lng.toString();e.setContent(`<p><a href='#'>${__("Set location here")}</a></p>`);$(a).find("a").on("click",t=>{t.preventDefault();e.remove();$("*[name=latitude]").val(o);$("*[name=longitude]").val(i).trigger("change")})});let e=$("*[name=latitude]").val();let a=$("*[name=longitude]").val();if(e&&a){this.#o(e,a)}$("*[name=latitude],*[name=longitude]").on("change",()=>{e=$("*[name=latitude]").val();a=$("*[name=longitude]").val();if(e&&a){this.#o(e,a)}})}#a(){let t="";const e=$("*[name=address]").val();const a=$("*[name=town]").val();const o=$("*[name=country]").val();if(e!==""){t+=e}if(a!==""){if(e!==""){t+=" "}t+=a}if(o!==""){if(e!==""||a!==""){t+=" "}t+=o}$(".leaflet-control-geocoder-form > input[type=text]").val(t)}#o(t,e){if(this.marker){this.map.removeLayer(this.marker)}this.marker=L.marker([t,e]).addTo(this.map);this.map.fitBounds(L.latLngBounds([this.marker.getLatLng()]),{padding:[50,50],maxZoom:10})}}export default GeolocationField;
/**
 * ---------------------------------------------------------------------
 *
 * GLPI - Gestionnaire Libre de Parc Informatique
 *
 * http://glpi-project.org
 *
 * @copyright 2015-2025 Teclib' and contributors.
 * @licence   https://www.gnu.org/licenses/gpl-3.0.html
 *
 * ---------------------------------------------------------------------
 *
 * LICENSE
 *
 * This file is part of GLPI.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 *
 * ---------------------------------------------------------------------
 */
export class GlpiIllustrationPickerController{#e;#t=0;#i;#n;constructor(e,t,i){this.#e=e;this.#i=t;this.#n=i;this.#s()}#s(){this.#e.addEventListener("click",e=>{const t=e.target.closest("[data-glpi-icon-picker-value]");if(t===null){return}this.#o(t)});this.#e.addEventListener("click",e=>{const t=e.target.closest("[data-glpi-icon-picker-go-to-page]");if(t===null){return}const i=t.dataset["glpiIconPickerGoToPage"];this.#a(i)});const e=_.debounce(e=>this.#r(e),200);this.#e.addEventListener("input",t=>{const i=t.target.closest("[data-glpi-icon-picker-filter]");if(i===null){return}e(i.value)});this.#e.querySelector("[data-glpi-icon-picker-use-custom-file]").addEventListener("click",async()=>{const e=await this.#c();if(e!==null){this.#l(e)}bootstrap.Modal.getInstance(this.#i).hide()});this.#i.addEventListener("show.bs.modal",()=>{const e=this.#e.querySelector(".nav-link.active").dataset.bsTarget;this.#e.querySelector(e).classList.add("show","active")});this.#i.addEventListener("shown.bs.modal",()=>{this.#e.querySelector("[data-glpi-icon-picker-filter]").focus()})}#o(e){const t=e.dataset["glpiIconPickerValue"];const i=e.querySelector("svg").querySelector("title");this.#u().value=t;const n=this.#e.querySelector("[data-glpi-icon-picker-value-preview]").querySelector("svg");const s=n.querySelector("title");const o=n.querySelector("use");const a=o.getAttribute("xlink:href");o.setAttribute("xlink:href",a.replace(/#.*/,`#${t}`));s.innerHTML=i.innerHTML;this.#e.querySelector("[data-glpi-icon-picker-value-preview-native]").classList.remove("d-none");this.#e.querySelector("[data-glpi-icon-picker-value-preview-custom]").classList.add("d-none")}#l(e){const t=`${this.#n}${e}`;this.#u().value=t;this.#e.querySelector("[data-glpi-icon-picker-value-preview-custom]").querySelector("img").src=`${CFG_GLPI.root_doc}/UI/Illustration/CustomIllustration/${e}`;this.#e.querySelector("[data-glpi-icon-picker-value-preview-custom]").classList.remove("d-none");this.#e.querySelector("[data-glpi-icon-picker-value-preview-native]").classList.add("d-none")}async#r(e=""){if(this.#t==0){this.#h().classList.add("d-none");this.#d().classList.remove("d-none");this.#p().style.opacity=.7;this.#p().style["pointer-events"]="none"}this.#t++;await this.#g(e,1);this.#t--;if(this.#t==0){this.#h().classList.remove("d-none");this.#d().classList.add("d-none");this.#p().style.opacity=1;this.#p().style["pointer-events"]=null}}async#a(e){this.#e.querySelectorAll("[data-glpi-icon-picker-go-to-page]").forEach(e=>e.classList.remove("active"));const t=this.#e.querySelector(`[data-glpi-icon-picker-go-to-page="${CSS.escape(e)}"]`);t.classList.add("active");t.classList.add("btn-loading");this.#p().style.opacity=.7;this.#p().style["pointer-events"]="none";await this.#g(this.#v().value,e);this.#p().style.opacity=1;this.#p().style["pointer-events"]=null}async#g(e="",t=1){const i=`${CFG_GLPI.root_doc}/UI/Illustration/Search`;const n=new URLSearchParams({filter:e,page:t,page_size:this.#S()});const s=await fetch(`${i}?${n}`);this.#p().innerHTML=await s.text()}async#c(){const e=this.#e.querySelectorAll("input[name^='_custom_icon']");let t=null;for(const i of e){t=i;break}if(t===null){return null}const i=new FormData;i.append("filename",t.value);const n=`${CFG_GLPI.root_doc}/UI/Illustration/Upload`;const s=await fetch(n,{method:"POST",body:i,headers:{"X-Requested-With":"XMLHttpRequest","X-Glpi-Csrf-Token":getAjaxCsrfToken()}});const o=await s.json();return o.file}#v(){return this.#e.querySelector("[data-glpi-icon-picker-filter]")}#S(){return this.#e.querySelector("[data-glpi-icon-picker-page-size]").dataset["glpiIconPickerPageSize"]}#u(){return this.#e.querySelector("[data-glpi-icon-picker-value]")}#h(){return this.#e.querySelector("[data-glpi-icon-picker-filter-default-icon]")}#d(){return this.#e.querySelector("[data-glpi-icon-picker-filter-loading-icon]")}#p(){return this.#e.querySelector("[data-glpi-icon-picker-body]")}}
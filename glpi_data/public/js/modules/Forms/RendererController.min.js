/**
 * ---------------------------------------------------------------------
 *
 * GLPI - Gestionnaire Libre de Parc Informatique
 *
 * http://glpi-project.org
 *
 * @copyright 2015-2025 Teclib' and contributors.
 * @copyright 2003-2014 by the INDEPNET Development Team.
 * @licence   https://www.gnu.org/licenses/gpl-3.0.html
 *
 * ---------------------------------------------------------------------
 *
 * LICENSE
 *
 * This file is part of GLPI.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 *
 * ---------------------------------------------------------------------
 */
import{GlpiFormConditionEngine}from"/js/modules/Forms/Condition/Engine.js";export class GlpiFormRendererController{#e;#t;#i;#n;constructor(e,t){this.#e=document.querySelector(e);if($(this.#e).prop("tagName")!="FORM"){throw new Error("Target must be a valid form")}this.#n=this.#e.dataset.glpiFormRenderLayout||"step_by_step";this.#t=0;this.#r();$(this.#e).find("[data-glpi-form-renderer-action=submit]").removeAttr("disabled");this.#i=new GlpiFormConditionEngine(t);this.#s();this.#o()}#r(){const e="data-glpi-form-renderer-action";$(this.#e).find(`[${e}=submit]`).on("click",()=>this.#a());$(this.#e).find(`[${e}=next-section]`).on("click",()=>this.#d());$(this.#e).find(`[${e}=previous-section]`).on("click",()=>this.#l());const t=_.debounce(()=>this.#c(),400);$(document).on("input tinyMCEInput glpi_fileupload_remove",this.#e,()=>{this.#p();t()});$(this.#e).on("change",'[data-glpi-form-renderer-delegation-container] select[name="delegation_users_id"]',e=>this.#g(e));$(this.#e).removeClass("pointer-events-none")}#f(){if(window.tinymce!==undefined){tinymce.get().forEach(e=>e.save())}}async#m(){this.#f();if(this.#n==="single_page"){return await this.#h()}const e=$(this.#e).find(`[data-glpi-form-renderer-section="${CSS.escape(this.#t)}"]`);const t=e.data("glpi-form-renderer-uuid");const i=await $.ajax({url:`${CFG_GLPI.root_doc}/Form/ValidateAnswers`,type:"POST",data:`${$(this.#e).serialize()}&section_uuid=${t}`,dataType:"json"});return this.#u(i)}async#h(){const e=await $.ajax({url:`${CFG_GLPI.root_doc}/Form/ValidateAnswers`,type:"POST",data:$(this.#e).serialize(),dataType:"json"});return this.#u(e)}#u(e){$(this.#e).find(".invalid-tooltip").remove();$(this.#e).find(".is-invalid").removeClass("is-invalid").removeAttr("aria-invalid").removeAttr("aria-errormessage");if(e.success===false){Object.values(e.errors).forEach(e=>{const t=$(`[data-glpi-form-renderer-id="${CSS.escape(e.question_id)}"][data-glpi-form-renderer-question]`);if(!t.length){return}const i=t.find("input:not([type=hidden]):not([data-uploader-name]):not(.select2-search__field), select, textarea");if(!i.length){return}const n=`error-${e.question_id}`;i.addClass("is-invalid").attr("aria-invalid","true").attr("aria-errormessage",n);let r;if(i.filter('[type="radio"], [type="checkbox"]').length>0){r=i.first().closest(".form-check").parent();if(r.length===0){r=i.first().parent()}}else{r=i.parent()}r.append(`<span id="${_.escape(n)}" class="invalid-tooltip">${_.escape(e.message)}</span>`)});return false}return true}async#a(){const e=$(this.#e).find("button[data-glpi-form-renderer-action=submit]");try{this.#p();e.addClass("btn-loading");this.#f();if(!await this.#m()){this.#s();return}const t=await $.post({url:$(this.#e).prop("action"),data:$(this.#e).serialize()});glpi_toast_info(__("Item successfully created: %s").replace("%s",t.links_to_created_items.join(", ")));$(this.#e).find("[data-glpi-form-renderer-success]").removeClass("d-none");let i=`\n                [data-glpi-form-renderer-form-header],\n                [data-glpi-form-renderer-delegation-container],\n                [data-glpi-form-renderer-actions]\n            `;if(this.#n==="single_page"){i+=`, [data-glpi-form-renderer-section]`}else{i+=`,\n                    [data-glpi-form-renderer-section="${CSS.escape(this.#t)}"],\n                    [data-glpi-form-renderer-parent-section="${CSS.escape(this.#t)}"]\n                `}$(this.#e).find(i).addClass("d-none")}catch(e){console.error(e);let t=__("Failed to submit form, please contact your administrator.");if(e.responseJSON&&e.responseJSON.errors&&e.responseJSON.errors.length>0){const i=e.responseJSON.errors.map(e=>_.escape(e)).join("<br>");t=`${t}<br><br><strong>${__("Details:")}</strong><br>${i}`}glpi_toast_error(t)}finally{this.#s();e.removeClass("btn-loading")}}async#d(){if(this.#n==="single_page"){return}if(!await this.#m()){return}$(this.#e).find(`\n                [data-glpi-form-renderer-section="${CSS.escape(this.#t)}"],\n                [data-glpi-form-renderer-parent-section="${CSS.escape(this.#t)}"]\n            `).addClass("d-none");const e=this.#_();if(e===null){throw new Error("Impossible to load the next section")}this.#t=e;$(this.#e).find(`\n                [data-glpi-form-renderer-section="${CSS.escape(this.#t)}"],\n                [data-glpi-form-renderer-parent-section="${CSS.escape(this.#t)}"]\n            `).removeClass("d-none");this.#o();$("[data-glpi-form-renderer-section]:visible")[0].scrollIntoView()}#l(){if(this.#n==="single_page"){return}$(this.#e).find(`\n                [data-glpi-form-renderer-section="${CSS.escape(this.#t)}"],\n                [data-glpi-form-renderer-parent-section="${CSS.escape(this.#t)}"]\n            `).addClass("d-none");const e=this.#b();if(e===null){throw new Error("Impossible to load the previous section")}this.#t=e;$(this.#e).find(`\n                [data-glpi-form-renderer-section="${CSS.escape(this.#t)}"],\n                [data-glpi-form-renderer-parent-section="${CSS.escape(this.#t)}"]\n            `).removeClass("d-none");this.#o();$("[data-glpi-form-renderer-section]:visible")[0].scrollIntoView()}#o(){if(this.#n==="single_page"){return}if(this.#y()){$(this.#e).find('[data-glpi-form-renderer-action="submit"]').addClass("d-none");$(this.#e).find('[data-glpi-form-renderer-action="next-section"]').removeClass("d-none")}else{$(this.#e).find('[data-glpi-form-renderer-action="submit"]').removeClass("d-none");$(this.#e).find('[data-glpi-form-renderer-action="next-section"]').addClass("d-none")}if(this.#$()){$(this.#e).find('[data-glpi-form-renderer-action="previous-section"]').removeClass("d-none")}else{$(this.#e).find('[data-glpi-form-renderer-action="previous-section"]').addClass("d-none")}}async#c(){const e=await this.#i.computeVisiblity(this.#e);this.#S(e);this.#s()}#S(e){const t=this.#e;const i=t.querySelector('[data-glpi-form-renderer-action="submit"]');if(i!==null){this.#v(i,e.form_visibility)}for(const[i,n]of Object.entries(e.sections_visibility)){const e=t.querySelector(`[data-glpi-form-renderer-section][data-glpi-form-renderer-id="${CSS.escape(i)}"]`);if(e===null){continue}if($(e).data("glpi-form-renderer-section")==this.#t){continue}this.#v(e,n)}for(const[i,n]of Object.entries(e.questions_visibility)){const e=t.querySelector(`[data-glpi-form-renderer-question][data-glpi-form-renderer-id="${CSS.escape(i)}"]`);if(e===null){continue}this.#v(e,n)}for(const[i,n]of Object.entries(e.comments_visibility)){const e=t.querySelector(`[data-glpi-form-renderer-comment][data-glpi-form-renderer-id="${CSS.escape(i)}"]`);if(e===null){continue}this.#v(e,n)}this.#o()}#v(e,t){if(t){e.removeAttribute("data-glpi-form-renderer-hidden-by-condition")}else{e.setAttribute("data-glpi-form-renderer-hidden-by-condition","")}}#_(){let e=null;const t=$(this.#e).find("[data-glpi-form-renderer-section]");t.each((t,i)=>{if(parseInt(i.dataset.glpiFormRendererSection)<=this.#t){return}if(i.dataset.glpiFormRendererHiddenByCondition===undefined){e=parseInt(i.dataset.glpiFormRendererSection);return false}});return e}#b(){let e=null;const t=$(this.#e).find("[data-glpi-form-renderer-section]");t.each((t,i)=>{if(i.dataset.glpiFormRendererSection>=this.#t){return false}if(i.dataset.glpiFormRendererHiddenByCondition===undefined){e=i.dataset.glpiFormRendererSection}});return e}#y(){return this.#_()!==null}#$(){return this.#b()!==null}#p(){$(this.#e).find("button[data-glpi-form-renderer-action]").addClass("pointer-events-none")}#s(){$(this.#e).find("button[data-glpi-form-renderer-action]").removeClass("pointer-events-none")}async#g(){const e=$(this.#e).find("[data-glpi-form-renderer-delegation-container]").find('select[name="delegation_users_id"]').val();const t=await $.get("/Form/Delegation",{selected_user_id:e});$(this.#e).find("[data-glpi-form-renderer-delegation-container]").html(t)}}
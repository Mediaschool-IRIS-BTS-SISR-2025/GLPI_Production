/**
 * ---------------------------------------------------------------------
 *
 * GLPI - Gestionnaire Libre de Parc Informatique
 *
 * http://glpi-project.org
 *
 * @copyright 2015-2025 Teclib' and contributors.
 * @copyright 2003-2014 by the INDEPNET Development Team.
 * @licence   https://www.gnu.org/licenses/gpl-3.0.html
 *
 * ---------------------------------------------------------------------
 *
 * LICENSE
 *
 * This file is part of GLPI.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 *
 * ---------------------------------------------------------------------
 */
export class GlpiFormQuestionTypeSelectable{_inputType;_container;constructor(t=null,e=null,i=false){this._inputType=t;this._container=$(e);if(this._container!==null){this._container.children().each((t,e)=>this._registerOptionListeners($(e)));this._container.siblings("div[data-glpi-form-editor-question-extra-details]").each((t,e)=>this._registerOptionListeners($(e)));if(i){this.#t().computeState()}this._container.on("sortupdate",()=>this._handleSortableUpdate());if(this._inputType==="radio"){this._container.find('input[type="radio"][checked]').prop("checked",true)}this.#e()}}#t(){return this._container.closest("form[data-glpi-form-editor-container]").data("controller")}getOptions(){const t=[];this._container.children().each((e,i)=>{const n=$(i).find('input[type="text"]');const o=$(i).find(`input[type="${CSS.escape(this._inputType)}"]`);const r=$(i).find("input[data-glpi-form-editor-question-option-order]");t[e]={value:n.val(),checked:o.is(":checked"),uuid:o.val(),order:parseInt(r.val())}});return t}setOptions(t){this._container.empty();for(const[,e]of Object.entries(t)){const t=this._container.closest("div[data-glpi-form-editor-question-type-specific]").find("template").get(0);const i=t.content.cloneNode(true);const n=getUUID();$(i).find('input[type="text"]').val(e.value).attr("name",`options[${n}]`);$(i).find(`input[type="${CSS.escape(this._inputType)}"]`).val(n).prop("checked",e.checked);$(i).find("input[data-glpi-form-editor-question-option-order]").val(e.order).attr("name",`options_order[${n}]`);const o=$(i).children().appendTo(this._container);this.#i($(o).find('input[type="text"]'));this._registerOptionListeners($(o));this.onAddOption($(o))}this.#n();this.#t().computeState();this.#e()}onAddOption(t){}onEditOption(t){}onRemoveOption(t){}_registerOptionListeners(t){t.find('input[type="text"]').on("input",t=>this.#o(t)).on("keydown",t=>this.#r(t));t.find("button[data-glpi-form-editor-question-option-remove]").on("click",t=>this.#s(t))}#e(){sortable(this._container,{handle:"[data-glpi-form-editor-question-option-handle]",acceptFrom:"[data-glpi-form-editor-selectable-question-options]",placeholderClass:"glpi-form-editor-drag-question-option-placeholder mb-1"})}#p(t,e=false,i=false){const n=this._container.closest("div[data-glpi-form-editor-question-type-specific]").find("template").get(0);const o=n.content.cloneNode(true);$(t).parent().after(o);this._registerOptionListeners($(t).parent().next());if(e){$(t).parent().next().find('input[type="text"]').trigger("focus")}if(i){$(t).parent().next().find("i").removeClass("d-none");$(t).parent().next().find("i[data-glpi-form-editor-question-option-handle]").css("visibility","visible")}const r=getUUID();$(t).parent().next().find('input[type="radio"], input[type="checkbox"]').val(r);$(t).parent().next().find('input[type="text"]').attr("name",`options[${r}]`);$(t).parent().next().find("input[data-glpi-form-editor-question-option-order]").attr("name",`options_order[${r}]`);$(t).parent().next().find("input[data-glpi-form-editor-question-option-order]").val(this._container.children().length+1);this.#t().computeState();this.onAddOption($(t).parent().next())}#s(t){t.target.closest("div").remove();t.stopPropagation();this.onRemoveOption(t.target.closest("div"))}#a(t){if($(t).parent().prev()!==undefined){$(t).parent().prev().find('input[type="text"]').trigger("focus")}else{const e=$(t).closest("div[data-glpi-form-editor-question-type-specific]").find("div[data-glpi-form-editor-selectable-question-options]").find('input[type="text"]').last();if(e!==undefined){e.trigger("focus")}}}#d(t){if($(t).parent().next().length>0){$(t).parent().next().find('input[type="text"]').trigger("focus")}else{const e=$(t).closest("div[data-glpi-form-editor-question-type-specific]").find('input[type="text"]').last();if(e!==undefined){e.trigger("focus")}}}#i(t){$(t).siblings("i[data-glpi-form-editor-question-option-handle]").css("visibility","visible");$(t).siblings('input[type="radio"], input[type="checkbox"]').prop("disabled",false);$(t).parent().removeAttr("data-glpi-form-editor-question-extra-details");$(t).siblings("button[data-glpi-form-editor-question-option-remove]").removeClass("d-none")}#l(t){const e=$(t).closest("div[data-glpi-form-editor-question-type-specific]").find("div[data-glpi-form-editor-selectable-question-options]").parent().children("div").last().find('input[type="text"]').get(0)===t;if(e){this.#p(t);$(t).parent().appendTo($(t).parent().siblings().filter("div[data-glpi-form-editor-selectable-question-options]").last());$(t).trigger("focus");this.#t().computeState()}}#c(t){$(t).parent().attr("data-glpi-form-editor-question-extra-details","");$(t).siblings('input[type="radio"], input[type="checkbox"]').prop("disabled",true);$(t).siblings('input[type="radio"], input[type="checkbox"]').prop("checked",false)}#f(t){const e=$(t).closest("div[data-glpi-form-editor-selectable-question-options]").children("div").last().find('input[type="text"]').get(0)===t;if(e){while($(t).parent().siblings("div").last().find('input[type="text"]').get(0).value===""){this.onRemoveOption($(t).parent());$(t).parent().siblings("div").last().remove()}$(t).closest("div[data-glpi-form-editor-question-type-specific]").find('input[type="text"]').last().trigger("focus");this.onRemoveOption($(t).parent());$(t).parent().remove()}}#n(){this._container.children().each((t,e)=>{$(e).find("input[data-glpi-form-editor-question-option-order]").val(t)});this._container.closest("div[data-glpi-form-editor-question-type-specific]").find("div[data-glpi-form-editor-question-extra-details]").find("input[data-glpi-form-editor-question-option-order]").val(this._container.children().length)}#o(t){const e=t.target;const i=$(e).closest("div[data-glpi-form-editor-question-type-specific]").find("div[data-glpi-form-editor-selectable-question-options]");if(e.value){this.#i(e);this.#l(e)}else{this.#c(e);this.#f(e)}if($(e).get(0)!==undefined){this.onEditOption($(e).parent())}sortable(i)}_handleSortableUpdate(){this.#n()}#r(t){const e=t.target;const i=$(e).closest("div[data-glpi-form-editor-selectable-question-options]");if(t.key==="Enter"){t.preventDefault();if(e.value){if($(e).parent().next().length>0&&$(e).parent().next().find('input[type="text"]').get(0).value===""){$(e).parent().next().find('input[type="text"]').trigger("focus");return}else if($(e).parent().next().length==0){$(e).closest("div[data-glpi-form-editor-question-type-specific]").find('input[type="text"]').last().trigger("focus");return}this.#p(e,true,true)}}else if(t.key==="Backspace"){const i=$(e).closest("div[data-glpi-form-editor-question-type-specific]").find("div[data-glpi-form-editor-selectable-question-options]").parent().children("div").last().find('input[type="text"]').get(0)===e;if(e.value===""&&!i){t.preventDefault();this.#a(e);this.#s(t)}}else if(t.key==="ArrowUp"||t.key==="Tab"&&t.shiftKey){t.preventDefault();this.#a(e)}else if(t.key==="ArrowDown"||t.key==="Tab"){t.preventDefault();this.#d(e)}sortable(i)}}
/**
 * ---------------------------------------------------------------------
 *
 * GLPI - Gestionnaire Libre de Parc Informatique
 *
 * http://glpi-project.org
 *
 * @copyright 2015-2025 Teclib' and contributors.
 * @licence   https://www.gnu.org/licenses/gpl-3.0.html
 *
 * ---------------------------------------------------------------------
 *
 * LICENSE
 *
 * This file is part of GLPI.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 *
 * ---------------------------------------------------------------------
 */
export class BaseConditionEditorController{#t;#i;#o;#n;#e;#s;#d;constructor(t,i,o,n,e,s,d){this.#t=t;if(this.#t.dataset.glpiConditionsEditorContainer===undefined){console.error(this.#t);throw new Error("Invalid container")}this.#e=i;this.#s=o;this.#d=d;this.#i=n;this.#o=e;this.#a();this.#n=s;const a=this.#t.querySelectorAll("[data-glpi-conditions-editor-enable-on-ready]");for(const t of a){t.removeAttribute("disabled")}}async renderEditor(){const t=this.#r();await this.#c(t)}setFormSections(t){this.#i=t}setFormQuestions(t){this.#o=t}setFormComments(t){this.#n=t}async#c(t){const i=this.#d;const o=await $.ajax({url:i,method:"POST",contentType:"application/json",data:JSON.stringify(t)});$(this.#t.querySelector("[data-glpi-conditions-editor]")).html(o);this.#l(t.conditions.length)}#a(){this.#t.addEventListener("click",t=>{const i=t.target;const o="[data-glpi-condition-editor-add-condition]";const n="[data-glpi-condition-editor-delete-condition]";if(i.closest(o)!==null){this.#h();return}else if(i.closest(n)!==null){const t=i.closest("[data-glpi-conditions-editor-condition]").dataset.glpiConditionsEditorConditionIndex;this.#u(t)}});$(this.#t).on("change","[data-glpi-conditions-editor-item], [data-glpi-conditions-editor-value-operator]",()=>this.renderEditor());const t=this.#t.querySelectorAll("[data-glpi-conditions-editor-strategy]");for(const i of t){i.addEventListener("change",t=>{const i=t.target.value;const o=this.#t.querySelector(`[data-glpi-conditions-editor-display-for-${CSS.escape(i)}]`)!==null;this.#t.querySelector(`[data-glpi-conditions-editor]`).classList.toggle("d-none",!o);const n=new CustomEvent("updated_strategy",{detail:{container:this.#t,strategy:i}});document.dispatchEvent(n)})}}async#h(){const t=this.#r();t.conditions.push({item:""});await this.#c(t)}async#u(t){const i=this.#r();i.conditions=i.conditions.filter((i,o)=>o!=t);await this.#c(i)}#r(){return{sections:this.#i,questions:this.#o,comments:this.#n,conditions:this.#m(),selected_item_uuid:this.#e,selected_item_type:this.#s}}#m(){const t=[];const i=this.#t.querySelectorAll("[data-glpi-conditions-editor-condition]");for(const o of i){const i={};const n=$(o).find("[data-glpi-conditions-editor-logic-operator]");if(n.length>0){i.logic_operator=n.val()}const e=$(o).find("[data-glpi-conditions-editor-item]");if(e.length>0){i.item=e.val()}const s=$(o).find("[data-glpi-conditions-editor-value-operator]");if(s.length>0){i.value_operator=s.val()}const d=$(o).find("[data-glpi-conditions-editor-value]");if(d.length===1){i.value=d.val()}else if(d.length>1){i.value={};d.each((t,o)=>{const n=o.name.split(/[[\]]+/);const e=n[n.length-2];i.value[e]=o.value})}t.push(i)}return t}#l(t){const i=new CustomEvent("conditions_count_changed",{detail:{container:this.#t,conditions_count:t}});document.dispatchEvent(i)}}
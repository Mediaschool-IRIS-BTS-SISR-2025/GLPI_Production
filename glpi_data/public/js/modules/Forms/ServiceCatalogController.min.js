/**
 * ---------------------------------------------------------------------
 *
 * GLPI - Gestionnaire Libre de Parc Informatique
 *
 * http://glpi-project.org
 *
 * @copyright 2015-2025 Teclib' and contributors.
 * @licence   https://www.gnu.org/licenses/gpl-3.0.html
 *
 * ---------------------------------------------------------------------
 *
 * LICENSE
 *
 * This file is part of GLPI.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 *
 * ---------------------------------------------------------------------
 */
export class GlpiFormServiceCatalogController{constructor(t){this.breadcrumb=[];this.sort_icons=t;const e=this.#t();const a=_.debounce(this.#e.bind(this),400,false);e.addEventListener("input",a);const r=new URLSearchParams(window.location.search);if(r.size>0){this.#a(r.toString())}window.addEventListener("popstate",t=>{if(t.state&&t.state.url_params){this.#a(t.state.url_params);if(t.state.breadcrumb){this.breadcrumb=t.state.breadcrumb}}});document.addEventListener("click",t=>{const e=$(t.target).closest("[data-composite-item]");if(e.length===1){t.preventDefault();this.#r(e.get(0))}const a=$(t.target).closest("[data-breadcrumb-item]");if(a.length===1){t.preventDefault();const e=this.breadcrumb.findIndex(t=>t.params===a.data("childrenUrlParameters"));this.breadcrumb=this.breadcrumb.slice(0,e+1);this.#a(a.data("childrenUrlParameters"));this.#s(a.data("childrenUrlParameters"))}const r=$(t.target).closest("[data-pagination-item]");if(r.length===1&&!r.hasClass("disabled")){t.preventDefault();this.#i(r.get(0))}});const s=document.querySelector("[data-glpi-service-catalog-sort-strategy]");setTimeout(()=>{setupAdaptDropdown(window.select2_configs[s.id]).on("select2:select",t=>{const e=t.params.data.id;this.#c(e)})},0)}async#e(){const t=this.#t();const e=new URLSearchParams({filter:t.value,page:1});this.#a(e)}async#r(t){const e=this.#t();e.value="";const a=t.dataset["childrenUrlParameters"];this.#a(a);this.#s(a)}async#a(t){const e=`${CFG_GLPI.root_doc}/ServiceCatalog/Items`;let a=await fetch(`${e}?${t}`);if(!a.ok){a=await fetch(`${e}`);this.#s("")}this.#o().innerHTML=await a.text();this.#n()}async#i(t){const e=t.dataset.childrenUrlParameters;this.#a(e);this.#s(e)}async#c(t){const e=new URLSearchParams;e.set("sort_strategy",t);e.set("filter",this.#t().value);e.set("page",1);this.#a(e)}#n(){const t=document.querySelector("#category-ancestors");if(t){this.breadcrumb=[{title:__("Service catalog"),params:"category=0"}];const e=JSON.parse(t.dataset.ancestors);e.forEach(t=>{this.breadcrumb.push({title:t.name,params:`category=${t.id}`})})}const e=document.querySelector("[data-breadcrumbs-container]");e.innerHTML="";this.breadcrumb.forEach((t,a)=>{const r=document.createElement("li");r.className="breadcrumb-item text-truncate";if(a===this.breadcrumb.length-1){r.classList.add("active")}const s=document.createElement("a");s.href=`?${t.params}`;s.textContent=t.title;if(a<this.breadcrumb.length-1){s.dataset.childrenUrlParameters=t.params;s.dataset.breadcrumbItem=""}r.appendChild(s);e.appendChild(r)})}#s(t){const e=new URL(window.location.href);e.search="";const a=new URLSearchParams(t);a.forEach((t,a)=>{if(a==="category"&&t==="0"){return}e.searchParams.set(a,t)});history.pushState({url_params:t,breadcrumb:this.breadcrumb},"",e)}#t(){return document.querySelector("[data-glpi-service-catalog-filter-items]")}#o(){return document.querySelector("[data-glpi-service-catalog-items]")}getTemplateForSortSelect(t){const e=this.sort_icons[t.id];return $(`<span class="w-full" title="${_.escape(t.text)}" aria-label="${_.escape(t.text)}"><i class="${_.escape(e)}"></i></span>`)}}
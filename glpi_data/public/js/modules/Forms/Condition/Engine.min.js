/**
 * ---------------------------------------------------------------------
 *
 * GLPI - Gestionnaire Libre de Parc Informatique
 *
 * http://glpi-project.org
 *
 * @copyright 2015-2025 Teclib' and contributors.
 * @licence   https://www.gnu.org/licenses/gpl-3.0.html
 *
 * ---------------------------------------------------------------------
 *
 * LICENSE
 *
 * This file is part of GLPI.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 *
 * ---------------------------------------------------------------------
 */
export class GlpiFormConditionEngine{#e;constructor(e){this.#e=e}async computeVisiblity(e){try{return await this.#t({answers:this.#n(e)})}catch(e){console.error(e);glpi_toast_error(__("An unexpected error occurred"))}}#n(e){const t=new Map;const n=new Map;const s=new Map;const o=[];const r=e.querySelectorAll("[data-glpi-form-renderer-criteria][data-glpi-form-renderer-question]");r.forEach(e=>{o.push(e.dataset.glpiFormRendererId)});const i=new FormData(e);for(const e of i.entries()){const r=e[0];const i=e[1];if(r.indexOf("answers_")!==0&&r.indexOf("_answers_")!==0){continue}if(r.includes("[")){const e=/^_?answers_([^[]+)(\[(\d*|[^\]]*)\])$/;const t=e.exec(r);if(t&&t[1]){const e=t[1];const r=t[3];if(o.indexOf(e)!==-1){if(r===""){if(!n.has(e)){n.set(e,[])}if(i!==""){n.get(e).push(i)}}else{if(!s.has(e)){s.set(e,{})}if(i!==""){s.get(e)[r]=i}}}}}else{const e=/^answers_(.*)$/;const n=e.exec(r);if(n&&n[1]){const e=n[1];if(o.indexOf(e)!==-1){t.set(e,i)}}}}for(const[e,s]of n.entries()){if(s.length>0){t.set(e,s)}}for(const[e,n]of s.entries()){if(Object.keys(n).length>0){t.set(e,n)}}return t}async#t(e){const t=new FormData;t.append("form_id",this.#e);for(const[n,s]of e.answers.entries()){this.#s(t,`answers[${n}]`,s)}const n=`${CFG_GLPI.root_doc}/Form/Condition/Engine`;const s=await fetch(n,{method:"POST",body:t,headers:{"X-Requested-With":"XMLHttpRequest","X-Glpi-Csrf-Token":getAjaxCsrfToken()}});if(!s.ok){throw new Error(s.status)}return s.json()}#s(e,t,n){if(n===null||n===undefined){return}if(Array.isArray(n)){for(const s of n){this.#s(e,`${t}[]`,s)}}else if(typeof n==="object"&&n!==null){for(const[s,o]of Object.entries(n)){this.#s(e,`${t}[${s}]`,o)}}else{e.append(t,n)}}}
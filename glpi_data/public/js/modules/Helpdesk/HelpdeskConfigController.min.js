/**
 * ---------------------------------------------------------------------
 *
 * GLPI - Gestionnaire Libre de Parc Informatique
 *
 * http://glpi-project.org
 *
 * @copyright 2015-2025 Teclib' and contributors.
 * @licence   https://www.gnu.org/licenses/gpl-3.0.html
 *
 * ---------------------------------------------------------------------
 *
 * LICENSE
 *
 * This file is part of GLPI.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 *
 * ---------------------------------------------------------------------
 */
export class GlpiHelpdeskConfigController{#e;#t;#i;constructor(e,t,i){this.#e=e;this.#t=t;this.#i=i;this.#o();this.#s()}#o(){const e=this.#e.querySelector("[data-glpi-helpdesk-config-tiles]");sortable(e,{placeholder:`<div class="col-12 col-sm-6 col-md-4 d-flex">\n                <div class="card my-2 flex-grow-1 border-primary border-dashed border-2 rounded opacity-50">\n                </div>\n            </div>`,handle:"[data-glpi-helpdesk-config-tile-handle]",placeholderClass:"not-a-real-class",items:"[data-glpi-draggable-item]"})}#s(){this.#e.querySelector("[data-glpi-helpdesk-config-reorder-action-save").addEventListener("click",async()=>{await this.#r()});this.#e.addEventListener("click",e=>{const t=e.target.closest("[data-glpi-helpdesk-config-action-delete]");if(t===null){return}const i=t.dataset;this.#a(e.target.closest("form"),i.glpiHelpdeskConfigActionDeleteId,i.glpiHelpdeskConfigActionDeleteItemtype)});this.#e.addEventListener("click",e=>{const t=e.target.closest("[data-glpi-helpdesk-config-action-show-edit-form]");if(t===null){return}const i=t.closest("[data-glpi-helpdesk-config-tile-container]");this.#n(i)});this.#e.addEventListener("click",e=>{const t=e.target.closest("[data-glpi-helpdesk-config-edit-tile-save]");if(t===null){return}this.#l(e.target.closest("form"))});this.#e.addEventListener("click",e=>{const t=e.target.closest("[data-glpi-helpdesk-config-action-new-tile]");if(t===null){return}this.#d()});this.#e.addEventListener("click",e=>{const t=e.target.closest("[data-glpi-helpdesk-config-add-tile-submit]");if(t===null){return}this.#c(e.target.closest("form"))});$(this.#e).on("change","[data-glpi-helpdesk-config-add-tile-type]",e=>{this.#p(e.target.value)})}async#r(){try{const e=new FormData;e.append("itemtype_item",this.#t);e.append("items_id_item",this.#i);this.#g().forEach(t=>e.append("order[]",t));const t=`${CFG_GLPI.root_doc}/Config/Helpdesk/SetTilesOrder`;const i=await fetch(t,{method:"POST",body:e,headers:{"X-Requested-With":"XMLHttpRequest","X-Glpi-Csrf-Token":getAjaxCsrfToken()}});if(!i.ok){throw new Error(i.status)}this.#h().innerHTML=await i.text();glpi_toast_info(__("Configuration updated successfully."))}catch(e){glpi_toast_error(__("An unexpected error occurred"));console.error(e)}}#g(){const e=this.#e.querySelectorAll("[data-glpi-helpdesk-config-item-tile-id]");return[...e].map(e=>e.dataset.glpiHelpdeskConfigItemTileId)}#h(){return this.#e.querySelector("[data-glpi-helpdesk-config-tiles]")}#f(){return this.#e.querySelector("[data-glpi-helpdesk-config-tile-form]")}#m(){return this.#e.querySelector("[data-glpi-helpdesk-config-tile-form-loading]")}#u(){return this.#e.querySelector("[data-glpi-helpdesk-config-tile-form-title]")}async#a(e,t,i){e.querySelector("[data-glpi-helpdesk-config-delete-tile-icon]").classList.remove("d-none");e.querySelector("[data-glpi-helpdesk-config-delete-tile-spinner-icon]").classList.add("d-none");e.querySelector("[data-glpi-helpdesk-config-edit-tile-save]").disabled=true;e.querySelector("[data-glpi-helpdesk-config-action-delete]").disabled=true;try{const e=new FormData;e.append("tile_id",t);e.append("tile_itemtype",i);const o=`${CFG_GLPI.root_doc}/Config/Helpdesk/DeleteTile`;const s=await fetch(o,{method:"POST",body:e,headers:{"X-Requested-With":"XMLHttpRequest","X-Glpi-Csrf-Token":getAjaxCsrfToken()}});if(!s.ok){throw new Error(s.status)}glpi_toast_info(__("Configuration updated successfully."));this.#h().innerHTML=await s.text();bootstrap.Offcanvas.getInstance("#tile-form-offcanvas").hide()}catch(e){glpi_toast_error(__("An unexpected error occurred"));console.error(e)}}async#n(e){try{this.#m().classList.remove("d-none");this.#f().classList.add("d-none");const t=e.querySelector("[data-glpi-helpdesk-config-tile]");const i=`${CFG_GLPI.root_doc}/Config/Helpdesk/ShowEditTileForm`;const o=new URLSearchParams({tile_id:t.dataset.glpiHelpdeskConfigTileId,tile_itemtype:t.dataset.glpiHelpdeskConfigTileItemtype});const s=await fetch(`${i}?${o}`);if(!s.ok){throw new Error(s.status)}$(this.#f()).html(await s.text());this.#u().innerHTML=__("Edit tile");this.#f().classList.remove("d-none");this.#m().classList.add("d-none")}catch(e){glpi_toast_error(__("An unexpected error occurred"));console.error(e)}}async#l(e){e.querySelector("[data-glpi-helpdesk-config-edit-tile-save-spinner-icon]").classList.remove("d-none");e.querySelector("[data-glpi-helpdesk-config-edit-tile-save-icon]").classList.add("d-none");e.querySelector("[data-glpi-helpdesk-config-edit-tile-save]").disabled=true;e.querySelector("[data-glpi-helpdesk-config-action-delete]").disabled=true;try{if(window.tinymce!==undefined){window.tinymce.get().forEach(e=>{e.save()})}const t=new FormData(e);const i=`${CFG_GLPI.root_doc}/Config/Helpdesk/UpdateTile`;const o=await fetch(i,{method:"POST",body:t,headers:{"X-Requested-With":"XMLHttpRequest","X-Glpi-Csrf-Token":getAjaxCsrfToken()}});if(!o.ok){throw new Error(o.status)}glpi_toast_info(__("Configuration updated successfully."));this.#h().innerHTML=await o.text();bootstrap.Offcanvas.getInstance("#tile-form-offcanvas").hide()}catch(e){glpi_toast_error(__("An unexpected error occurred"));console.error(e)}}async#d(){try{this.#m().classList.remove("d-none");this.#f().classList.add("d-none");const e=`${CFG_GLPI.root_doc}/Config/Helpdesk/ShowAddTileForm`;const t=await fetch(e);if(!t.ok){throw new Error(t.status)}$(this.#f()).html(await t.text());this.#u().innerHTML=__("Add tile");this.#f().classList.remove("d-none");this.#m().classList.add("d-none")}catch(e){glpi_toast_error(__("An unexpected error occurred"));console.error(e)}}async#c(e){e.querySelector("[data-glpi-helpdesk-config-add-tile-submit-spinner-icon]").classList.remove("d-none");e.querySelector("[data-glpi-helpdesk-config-add-tile-submit-plus-icon]").classList.add("d-none");e.querySelector("[data-glpi-helpdesk-config-add-tile-submit]").disabled=true;try{if(window.tinymce!==undefined){window.tinymce.get().forEach(e=>{e.save()})}const t=new FormData(e);t.append("_itemtype_item",this.#t);t.append("_items_id_item",this.#i);const i=`${CFG_GLPI.root_doc}/Config/Helpdesk/AddTile`;const o=await fetch(i,{method:"POST",body:t,headers:{"X-Requested-With":"XMLHttpRequest","X-Glpi-Csrf-Token":getAjaxCsrfToken()}});if(!o.ok){throw new Error(o.status)}glpi_toast_info(__("Configuration updated successfully."));this.#h().innerHTML=await o.text();bootstrap.Offcanvas.getInstance("#tile-form-offcanvas").hide()}catch(e){glpi_toast_error(__("An unexpected error occurred"));console.error(e)}}#p(e){const t=this.#e.querySelector("[data-glpi-helpdesk-config-add-tile-submit]");if(e==0){t.classList.add("d-none");t.classList.remove("d-flex")}else{t.classList.remove("d-none");t.classList.add("d-flex")}this.#e.querySelectorAll("[data-glpi-helpdesk-config-add-tile-form-for]").forEach(e=>{e.classList.add("d-none");e.querySelectorAll("input, select, textarea").forEach(e=>{e.disabled=true})});this.#e.querySelectorAll(`[data-glpi-helpdesk-config-add-tile-form-for="${CSS.escape(e)}"]`).forEach(e=>{e.classList.remove("d-none");e.querySelectorAll("input, select, textarea").forEach(e=>{e.disabled=false})})}}
/**
 * ---------------------------------------------------------------------
 *
 * GLPI - Gestionnaire Libre de Parc Informatique
 *
 * http://glpi-project.org
 *
 * @copyright 2015-2025 Teclib' and contributors.
 * @copyright 2003-2014 by the INDEPNET Development Team.
 * @licence   https://www.gnu.org/licenses/gpl-3.0.html
 *
 * ---------------------------------------------------------------------
 *
 * LICENSE
 *
 * This file is part of GLPI.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 *
 * ---------------------------------------------------------------------
 */
import GenericView from"/js/modules/Search/GenericView.js";window.GLPI=window.GLPI||{};window.GLPI.Search=window.GLPI.Search||{};window.GLPI.Search.Table=class t extends GenericView{sort_state={sort:[],order:[]};constructor(t,e=true,s={}){const r=$(`#${CSS.escape(t)}`).parent().find("table.search-results").attr("id");super(r);this.push_history=e;this.forced_params=s;const a=this.getElement().closest(".search-container");this.embedded_mode=!(a.length>0&&a.find("form.search-form-container").length>0);if(!this.embedded_mode){delete this.forced_params.criteria}this.shiftSelectAllCheckbox();this.toggleSavedSearch(true)}toggleSavedSearch(t){if(t){$(".bookmark_record").attr("title",_.unescape(__("Submit current search before saving it"))).prop("disabled",true)}else{$(".bookmark_record").attr("title",_.unescape(__("Save current search"))).prop("disabled",false)}}getElement(){return $(`#${CSS.escape(this.element_id)}`)}onColumnSortClick(t,e=false){const s=$(t);const r=this.getElement().find("thead th");const a=s.attr("data-sort-order");const o=$("[data-sort-num]").length;if(!e&&(a===null||a==="nosort")){r.each((t,e)=>{const s=$(e);s.attr("data-sort-num",null);s.attr("data-sort-order",null)})}const i=a==="ASC"?"DESC":a==="DESC"?o>1?"nosort":"ASC":"ASC";s.attr("data-sort-order",i);const n=s.attr("data-sort-num");const c=()=>{let t=[];r.each((e,s)=>{const r=$(s);if(r.attr("data-sort-num")!==undefined){t[r.attr("data-sort-num")]=r.attr("data-searchopt-id")}});t=t.filter(t=>t);r.each((e,s)=>{const r=$(s);r.attr("data-sort-num",undefined);const a=t.indexOf(r.attr("data-searchopt-id"));if(a!==-1){r.attr("data-sort-num",a)}})};c();if(n===undefined&&i!=="nosort"){s.attr("data-sort-num",r.filter(function(){return $(this).attr("data-sort-num")!==undefined}).length)}else if(i==="nosort"){s.attr("data-sort-num",undefined)}this.setSortStateFromColumns();this.refreshResults()}onLimitChange(t){const e=t.value;this.getResultsView().getAJAXContainer().find("select.search-limit-dropdown").each(function(){$(this).val(e)});this.refreshResults({start:0})}onPageChange(t){const e=$(t);e.closest(".pagination").find(".page-item").removeClass("selected");e.closest(".page-item").addClass("selected");this.refreshResults()}refreshResults(t={}){this.showLoadingSpinner();const e=this.getElement();const s=e.closest("form");const r=e.closest(".ajax-container");let a={};const o=()=>{window.location.reload()};try{const e=$(s).find("select.search-limit-dropdown").first().val();let i=$(r).closest(".search-container").find(".search-form-container").serializeArray();i=i.filter(t=>t["name"]!=="sort[]"&&t["name"]!=="order[]");const n={};i.forEach(t=>{n[t["name"]]=t["value"]});const c=$(r).find(".pagination .page-item.selected .page-link").attr("data-start");n["start"]=c||0;if(t["reset"]){a={action:"display_results",searchform_id:this.element_id,itemtype:this.getItemtype(),reset:"reset"}}else{a={action:"display_results",searchform_id:this.element_id,itemtype:this.getItemtype(),glpilist_limit:e};if(this.sort_state!==null){a["sort"]=this.sort_state["sort"];a["order"]=this.sort_state["order"]}a=Object.assign(a,n,this.forced_params,t)}if(this.push_history){history.pushState("","",`?${$.param(Object.assign(n,this.sort_state,t))}`)}$.ajax({url:`${CFG_GLPI.root_doc}/ajax/search.php`,method:"GET",data:a}).then(t=>{if(!(typeof t==="string"&&t.includes("search-card"))){o();return}r.html(t);this.getResultsView().setID(r.find(".masssearchform").attr("id"));this.getElement().trigger("search_refresh",[this.getElement()]);displaySessionMessages();this.hideLoadingSpinner();this.shiftSelectAllCheckbox();this.toggleSavedSearch(false)},()=>{o()})}catch{o()}}shiftSelectAllCheckbox(){$(`#${this.element_id} tbody input[type="checkbox"]`).shiftSelectable()}registerListeners(){super.registerListeners();const t=this.getResultsView().getAJAXContainer();const e=t.closest(".search-container");$(t).on("click","table.search-results th[data-searchopt-id]",t=>{t.stopPropagation();const e=$(t.target).closest("th").get(0);if($(e).data("nosort")){return}if(t.ctrlKey||t.metaKey){this.onColumnSortClick(e,true)}else{this.onColumnSortClick(e,false)}});$(t).on("change","select.search-limit-dropdown",t=>{this.onLimitChange(t.target)});$(t).on("click",".pagination .page-link",t=>{t.preventDefault();this.onPageChange(t.target)});$(e).on("click",'.search-form-container button[name="search"]',t=>{t.preventDefault();if(window.validateFormWithBootstrap(t)){this.onSearch()}});$(t).on("click",".trigger-sort",t=>{t.preventDefault();this.setSortStateFromSelects();this.refreshResults()});$(t).on("click",".sort-reset",t=>{const e=bootstrap.Tooltip.getInstance($(t.currentTarget)[0]);if(e!==null){e.dispose()}t.preventDefault();this.resetSortState();this.refreshResults()});$(t).on("click",".sort-container .add_sort",e=>{const s=t.find(".sort-container");e.preventDefault();this.setSortStateFromSelects();const r=this.sort_state["sort"].length;const a=s.find('input[name="_idor_token"]').val();$.post(`${CFG_GLPI.root_doc}/ajax/search.php`,{action:"display_sort_criteria",itemtype:this.getItemtype(),num:r+1,p:this.sort_state,_idor_token:a,used:this.sort_state["sort"]}).done(t=>{s.find(".list-group").append(t);this.setSortStateFromSelects()})});$(t).on("change",'select[name^="sort"], select[name^="order"]',t=>{t.preventDefault();this.setSortStateFromSelects()});$(t).on("click",".sort-container .remove-order-criteria",t=>{t.preventDefault();const e=bootstrap.Tooltip.getInstance($(t.currentTarget)[0]);if(e!==null){e.dispose()}const s=$(t.currentTarget).data("rowid");$(`#${s}`).remove();this.setSortStateFromSelects()})}getItemtype(){return this.getElement().closest("form").attr("data-search-itemtype")}resetSortState(){this.sort_state={sort:[],order:[]}}setSortStateFromColumns(){let t=this.getElement().find('thead th[data-searchopt-id]:not([data-searchopt-id=""])[data-sort-num]:not([data-sort-num=""])');if(t.length===0){return null}t=$(t.get().sort((t,e)=>$(t).attr("data-sort-num")-$(e).attr("data-sort-num")));this.resetSortState();t.each((t,e)=>{const s=$(e);const r=s.attr("data-sort-order");if(r!=="nosort"){this.sort_state["sort"].push(s.attr("data-searchopt-id"));this.sort_state["order"].push(r)}});return this.sort_state}setSortStateFromSelects(){const t=[];const e=[];$('select[name^="sort"]').each(function(){t.push($(this).val())});$('select[name^="order"]').each(function(){e.push($(this).val())});this.resetSortState();$.each(t,(t,s)=>{this.sort_state["sort"].push(s);this.sort_state["order"].push(e[t])})}};
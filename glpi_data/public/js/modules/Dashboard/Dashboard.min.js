/**
 * ---------------------------------------------------------------------
 *
 * GLPI - Gestionnaire Libre de Parc Informatique
 *
 * http://glpi-project.org
 *
 * @copyright 2015-2025 Teclib' and contributors.
 * @copyright 2003-2014 by the INDEPNET Development Team.
 * @licence   https://www.gnu.org/licenses/gpl-3.0.html
 *
 * ---------------------------------------------------------------------
 *
 * LICENSE
 *
 * This file is part of GLPI.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 *
 * ---------------------------------------------------------------------
 */
window.GLPI=window.GLPI||{};window.GLPI.Dashboard={dashboards:{},getActiveDashboard:function(){let t="";$.each(this.dashboards,(e,s)=>{if($(s.elem_dom).is(":visible")){t=e;return false}});return this.dashboards[t]}};class GLPIDashboard{constructor(t){this.grid=null;this.elem_id="";this.element=null;this.elem_dom=null;this.rand=null;this.interval=null;this.current_name=null;this.markdown_editors=[];this.all_cards=[];this.all_widgets=[];this.edit_mode=false;this.filter_mode=false;this.embed=false;this.ajax_cards=false;this.context="core";this.markdown_contents=[];this.dash_width=0;this.cell_margin=3;this.cols=26;this.cache_key="";this.filters="{}";this.filters_selector="";GridStack.renderCB=(t,e)=>{t.parentElement.innerHTML=e.content};let e=typeof t!=="undefined"?t:{};const s={cols:24,rows:24,cell_length:40,cell_margin:5,rand:"",embed:false,token:null,entities_id:null,is_recursive:null,ajax_cards:true,all_cards:[],context:"core"};e=Object.assign({},s,e);this.rand=parseInt(e.rand);this.elem_id="#dashboard-"+this.rand;this.element=$(this.elem_id);this.elem_dom=this.element[0];this.current_name=$(`${this.elem_id} .dashboard-select`).val()||e.current;this.embed=e.embed;this.token=e.token;this.entities_id=e.entities_id;this.is_recursive=e.is_recursive;this.ajax_cards=e.ajax_cards;this.all_cards=e.all_cards;this.all_widgets=e.all_widgets;this.context=e.context;this.dash_width=this.element.width();this.cell_margin=e.cell_margin;this.cols=e.cols;this.cache_key=e.cache_key||"";this.filters_selector=this.elem_id+" .filters";const i=this.elem_dom.getBoundingClientRect();const a=i.left+(window.innerWidth-i.right)+.02;this.grid=GridStack.init({column:e.cols,maxRow:e.rows+1,margin:this.cell_margin,float:true,animate:false,draggable:{cancel:"textarea"},minWidth:768-a},`#grid-stack-${e.rand}`);this.grid.setStatic(true);this.resizeSelect();this.initFilters();this.refreshDashboard();if(!this.ajax_cards){this.fitNumbers();this.animateNumbers()}$(`${this.elem_id} .toolbar .dashboard_select`).change(t=>{const e=$(t.currentTarget);this.current_name=e.val();const s=e.find("option:selected").text();$(".dashboard-name").val(s);this.refreshDashboard();this.setLastDashboard();this.initFilters()});$(`${this.elem_id} .toolbar .add-dashboard`).click(()=>{this.addForm()});$(document).on("submit",".display-add-dashboard-form",t=>{t.preventDefault();glpi_close_all_dialogs();const e=$(t.currentTarget);const s={};$.each(e.closest(".display-add-dashboard-form").serializeArray(),function(){s[this.name]=this.value});this.addNew(s)});$(`${this.elem_id} .toolbar .delete-dashboard`).click(()=>{this.delete()});$(`${this.elem_id} .toolbar .clone-dashboard`).click(()=>{this.clone()});$(`${this.elem_id} .toolbar .open-embed`).click(()=>{glpi_ajax_dialog({title:__("Share or embed this dashboard"),url:CFG_GLPI.root_doc+"/ajax/dashboard.php",params:{action:"display_embed_form",dashboard:this.current_name}})});$(`${this.elem_id} .toolbar .edit-dashboard`).click(t=>{const e=!$(t.currentTarget).hasClass("active");this.setEditMode(e);this.setFilterMode(e)});$(`${this.elem_id} .toolbar .filter-dashboard`).on("click",t=>{const e=!$(t.currentTarget).hasClass("active");this.setFilterMode(e)});$(`${this.elem_id} .toggle-fullscreen`).click(t=>{this.toggleFullscreenMode($(t.currentTarget))});$(document).on("fullscreenchange webkitfullscreenchange mozfullscreenchange MSFullscreenChange",()=>{if(!document.webkitIsFullScreen&&!document.mozFullScreen&&!document.msFullscreenElement){this.removeFullscreenModeClass()}});$(`${this.elem_id} .toolbar .night-mode`).click(t=>{$(t.currentTarget).toggleClass("active");this.element.toggleClass("theme-dark")});$(`${this.elem_id} .toolbar .auto-refresh`).click(t=>{const e=$(t.currentTarget);e.toggleClass("active");const s=e.hasClass("active");if(s){let t=parseInt(CFG_GLPI.refresh_views);if(t===0||Number.isNaN(t)){t=30}const e=t*60;this.interval=setInterval(()=>{this.refreshDashboard()},e*1e3)}else{clearInterval(this.interval)}});let r;$(window).on("resize",t=>{if(t.target.constructor.name!=="Window"){return}window.clearTimeout(r);r=window.setTimeout(()=>{this.fitNumbers()},200)});$(document).on("click",".display-rights-form .save_rights",t=>{glpi_close_all_dialogs();const e=$(t.target);const s={};$.each(e.closest(".display-rights-form").serializeArray(),(t,e)=>{const i=e.value.split("-");if(i.length!==2){return}const a=i[0];const r=i[1];if(!(a in s)){s[a]=[]}s[a].push(r)});const i=e.closest(".display-rights-form").find('select[name="is_private"]').val();$.post({url:CFG_GLPI.root_doc+"/ajax/dashboard.php",data:{action:"save_rights",dashboard:this.current_name,rights:s,is_private:i}})});this.grid.on("dragstop",()=>{this.saveDashboard()});this.grid.on("resizestop",(t,e)=>{this.saveDashboard();this.resetComputedWidth($("body").find(".big-number").find(".formatted-number"));this.resetComputedWidth($("body").find(".big-number").find(".label"));this.fitNumbers($(e));this.animateNumbers($(e))});$(this.elem_id).on("click",".delete-item",t=>{const e=$(t.target).closest(".grid-stack-item").get(0);this.grid.removeWidget(e);this.saveDashboard()}).on("click",".refresh-item",t=>{const e=$(t.target);const s=e.closest(".grid-stack-item");const i=s.attr("gs-id");this.getCardsAjax(`[gs-id="${CSS.escape(i)}"]`)}).on("click",".edit-item",t=>{const e=$(t.target);const s=e.parent().parent(".grid-stack-item");const i=s.data("card-options");glpi_ajax_dialog({title:__("Edit this card"),url:CFG_GLPI.root_doc+"/ajax/dashboard.php",params:{action:"display_edit_widget",dashboard:this.current_name,gridstack_id:s.attr("gs-id"),card_id:i.card_id,x:s.attr("gs-x")??0,y:s.attr("gs-y")??0,width:s.attr("gs-w")??1,height:s.attr("gs-h")??1,card_options:i},modalclass:"modal-lg"})}).on("click",".cell-add",t=>{const e=$(t.target);glpi_ajax_dialog({title:__("Add a card"),url:CFG_GLPI.root_doc+"/ajax/dashboard.php",params:{action:"display_add_widget",dashboard:this.current_name,x:e.data("x"),y:e.data("y")},modalclass:"modal-lg"})}).on("click",".filters_toolbar .add-filter",()=>{glpi_close_all_dialogs();const t=this.getFiltersFromDB();const e=Object.keys(t);glpi_ajax_dialog({title:__("Add a filter"),url:CFG_GLPI.root_doc+"/ajax/dashboard.php",params:{action:"display_add_filter",dashboard:this.current_name,used:e}})}).on("click",".filters_toolbar .delete-filter",t=>{const e=$(t.target).closest(".filter");const s=e.data("filter-id");e.remove();const i=this.getFiltersFromDB();delete i[s];this.setFiltersInDB(i);this.refreshCardsImpactedByFilter(s)});$(document).on("submit",".display-widget-form ",t=>{t.preventDefault();this.setWidgetFromForm($(t.target))});$(document).on("submit",".display-filter-form ",t=>{t.preventDefault();const e=$(t.target);this.setFilterFromForm(e)});$(document).on("click",".save-dashboard-name ",t=>{t.preventDefault();$('.dashboard_select option[value="'+CSS.escape(this.current_name)+'"]').text($(".dashboard-name").val());this.saveDashboard();$(".display-message").addClass("success").text(_.unescape(__("Saved"))).show("fade").delay(2e3).hide("fade")});$(document).on("select2:select",".display-widget-form select[name=card_id]",t=>{const e=t.params.data;const s=e.id;const i=$(t.target).closest(".display-widget-form").find(".widgettype_field");const a=this.all_cards[s].widgettype;const r=a.length===1;i.show().find("input[type=radio]").next("label").css("display","none").end().filter(a.map(t=>`[value="${CSS.escape(t)}"]`).join(",")).prop("checked",r).trigger("change").next("label").css("display","inline-block")});$(document).on("change",".display-widget-form [name=widgettype]",t=>{const e=$(t.target);const s=e.val();const i=this.all_widgets[s];const a=i.gradient||false;const r=i.pointlbl||false;const d=i.limit||false;const o=i.width||2;const n=i.height||2;const l=e.closest(".display-widget-form");l.find(".gradient_field").toggle(a);l.find(".pointlbl_field").toggle(r);l.find(".limit_field").toggle(d);const c=l.find('[name="width"]');const h=l.find('[name="height"]');if(c.val()==0){c.val(o)}if(h.val()==0){h.val(n)}});$(document).on("input",".card.markdown textarea.markdown_content",t=>{this.saveMarkdown($(t.target))});$(window).on("resize.fittext",()=>{this.computeWidth($("body").find(".big-number").find(".formatted-number"));this.computeWidth($("body").find(".big-number").find(".label"))});window.GLPI.Dashboard.dashboards[this.rand]=this}saveMarkdown(t){const e=t.closest(".grid-stack-item");const s=t.val();const i=e.attr("gs-id");e.addClass("dirty");this.markdown_contents[i]=s}setWidgetFromForm(t){glpi_close_all_dialogs();const e={};$.each(t.serializeArray(),function(){e[this.name]=this.value});if(e.card_id==="0"){return false}e.card_options=e.card_options||{};if(typeof e.card_options==="string"){e.card_options=JSON.parse(e.card_options)}const s="old_id"in e&&e.old_id.length>0;e.card_options.color=e.color||null;e.card_options.widgettype=e.widgettype||null;e.card_options.palette=e.palette||null;e.card_options.use_gradient=e.use_gradient||0;e.card_options.point_labels=e.point_labels||0;e.card_options.legend=e.legend||0;e.card_options.limit=e.limit||7;if(e.card_id==="markdown_editable"&&!("markdown_content"in e.card_options)){e.card_options.markdown_content=""}if(s===true){if(e.old_id==="0"){return false}const t=$('.grid-stack-item[gs-id="'+CSS.escape(e.old_id)+'"]')[0];this.grid.removeWidget(t)}const i=getUuidV4();e.gridstack_id=e.card_id+"_"+i;e.card_options.card_id=e.card_id;e.card_options.gridstack_id=e.gridstack_id;const a=e.card_options;a.force=true;a.apply_filters=this.getFiltersFromDB();const r=this.addWidget(e);$.get({url:CFG_GLPI.root_doc+"/ajax/dashboard.php",data:{action:"get_card",dashboard:this.current_name,card_id:e.card_id,cache_key:this.cache_key,args:a}}).then(t=>{r.children(".grid-stack-item-content").append(t);this.fitNumbers(r);this.animateNumbers(r);this.saveDashboard()})}addWidget(t){const e=t.gridstack_id;const s=parseInt(t.x||-1);const i=parseInt(t.y||-1);const a=parseInt(t.width||2);const r=parseInt(t.height||2);const d=t.card_options||{};const o=`\n            <span class="controls">\n                <i class="refresh-item ti ti-refresh" title="${__("Refresh this card")}"></i>\n                <i class="edit-item ti ti-edit" title="${__("Edit this card")}"></i>\n                <i class="delete-item ti ti-x" title="${__("Delete this card")}"></i>\n            </span>\n            <div class="grid-stack-item-content"></div>`;const n=this.grid.addWidget({x:s,y:i,w:a,h:r,autoPosition:s<0||i<0,id:e,content:o});$(n).attr("data-card-options",JSON.stringify(d));return $(n)}setFilterFromForm(t){glpi_close_all_dialogs();const e={};$.each(t.serializeArray(),function(){e[this.name]=this.value});$.get({url:CFG_GLPI.root_doc+"/ajax/dashboard.php",data:{action:"get_filter",filter_id:e.filter_id}}).then(t=>{$(this.filters_selector).append(t);this.saveFilter(e.filter_id,[])})}refreshDashboard(){const t=$(this.elem_id+" .grid-stack");this.grid.removeAll();const e={dashboard:this.current_name,action:"get_dashboard_items"};if(this.embed){e.embed=1;e.token=this.token;e.entities_id=this.entities_id;e.is_recursive=this.is_recursive}$.get({url:CFG_GLPI.root_doc+"/ajax/dashboard.php",data:e}).then(e=>{t.prepend(e);t.find(".grid-stack-item").each((t,e)=>{this.grid.makeWidget(e)});this.getCardsAjax();const s=CFG_GLPI["is_demo_dashboards"]==="1";if(s){$(this.elem_id).find(".filters_toolbar").addClass("d-none");$(this.elem_id).find(".placeholder_info").removeClass("d-none")}else{$(this.elem_id).find(".placeholder_info").addClass("d-none");$(this.elem_id).find(".filters_toolbar").removeClass("d-none")}})}setLastDashboard(){$.post({url:CFG_GLPI.root_doc+"/ajax/dashboard.php",data:{dashboard:this.current_name,page:(location.origin+location.pathname).replace(CFG_GLPI.url_base,""),action:"set_last_dashboard"}})}saveFilter(t,e){const s=this.getFiltersFromDB();s[t]=e;this.setFiltersInDB(s);sortable(this.filters_selector,"reload");this.refreshCardsImpactedByFilter(t)}refreshCardsImpactedByFilter(t){$(".dashboard .card.filter-"+t).each((t,e)=>{const s=$(e).closest(".grid-stack-item");const i=s.attr("gs-id");this.getCardsAjax(`[gs-id="${CSS.escape(i)}"]`)})}saveDashboard(t){t=t|false;const e=$.makeArray(this.element.find(".grid-stack-item:visible:not(.grid-stack-placeholder)")).map(t=>{const e=$(t).attr("gs-id");const s=$(t).data("card-options");if(_.keys(this.markdown_contents).length>0&&e in this.markdown_contents){s.markdown_content=this.markdown_contents[e]}return e?{gridstack_id:$(t).attr("gs-id"),card_id:s.card_id,x:$(t).attr("gs-x")??0,y:$(t).attr("gs-y")??0,width:$(t).attr("gs-w"),height:$(t).attr("gs-h")??1,card_options:s}:null});$.post({url:CFG_GLPI.root_doc+"/ajax/dashboard.php",data:{action:"save_items",dashboard:this.current_name,items:e,title:$(".dashboard-name").val()}}).then(()=>{if(t){this.refreshDashboard()}})}computeWidth(t){t.each(function(){const t=$(this).parent().parent().width();const e=$(this).parent().parent().height();if(t>e){const s=.35;const i=e/s;const a=i/t*100;const r=a/2;$(this).css("width",r+"%")}})}resetComputedWidth(t){t.each(function(){$(this).css("width","100%")})}fitNumbers(t){t=t||$("body");let e=1.16;if(this.dash_width<=700||$(this.grid.el).hasClass("grid-stack-one-column-mode")){e=1.8}this.computeWidth(t.find(".big-number").find(".formatted-number"));this.computeWidth(t.find(".big-number").find(".label"));t.find(".big-number").find(".formatted-number").fitText(e);t.find(".summary-numbers").find(".formatted-number").fitText(e-.65);t.find(".summary-numbers").find(".line .label").fitText(e-.2);t.find(".big-number").find(".label").fitText(e-.2,{minFontSize:"12px"});this.resetComputedWidth(t.find(".big-number").find(".formatted-number"));this.resetComputedWidth(t.find(".big-number").find(".label"))}animateNumbers(t){t=t||$("body");t.find(".multiple-numbers, .summary-numbers, .big-number").find(".formatted-number").each(function(){const t=$(this);const e=t.data("precision");const s=t.children(".number");const i=s.text();if(isNaN(s.text())){return true}jQuery({Counter:0}).animate({Counter:s.text()},{duration:800,easing:"swing",step:function(){s.text(this.Counter.toFixed(e))},complete:function(){s.text(i)}})})}setEditMode(t){this.edit_mode=typeof t=="undefined"?true:t;const e=$(this.elem_id+" .toolbar .edit-dashboard");e.toggleClass("active",t);this.element.toggleClass("edit-mode",t);this.grid.setStatic(!t);if($(this.filters_selector).children().length>0){sortable(this.filters_selector,t?"enable":"disable")}if(!this.edit_mode){const t=$(".grid-stack-item.dirty");if(t.length>0){this.saveDashboard(true)}}}setFilterMode(t){this.filter_mode=typeof t=="undefined"?true:t;const e=$(this.elem_id+" .toolbar .filter-dashboard");e.toggleClass("active",t);this.element.toggleClass("filter-mode",t);sortable(".filters",t?"enable":"disable")}toggleFullscreenMode(t){const e=!t.hasClass("active");this.element.toggleClass("fullscreen");t.toggleClass("active");if(e){this.setEditMode(false)}if(e){GoInFullscreen(this.elem_dom)}else{GoOutFullscreen()}}removeFullscreenModeClass(){this.element.removeClass("fullscreen").find(".toggle-fullscreen").removeClass("active")}clone(){$.post({url:CFG_GLPI.root_doc+"/ajax/dashboard.php",data:{dashboard:this.current_name,action:"clone_dashboard"},dataType:"json"}).then(t=>{this.addNewDashbardInSelect(t.title,t.key)})}delete(){const t=__("Are you sure you want to delete the dashboard %s?").replace("%s",this.current_name);if(window.confirm(t,__("Delete this dashboard"))){$.post({url:CFG_GLPI.root_doc+"/ajax/dashboard.php",data:{action:"delete_dashboard",dashboard:this.current_name}}).then(()=>{$(this.elem_id+" .toolbar .dashboard_select").find(`option[value="${CSS.escape(this.current_name)}"]`).remove().end().prop("selectedIndex",0).trigger("change")})}}addForm(){glpi_ajax_dialog({title:__("Add a dashboard"),url:CFG_GLPI.root_doc+"/ajax/dashboard.php",params:{action:"add_new"}})}addNew(t){$.post({url:CFG_GLPI.root_doc+"/ajax/dashboard.php",data:{action:"save_new_dashboard",title:t.title,context:this.context}}).then(e=>{this.addNewDashbardInSelect(t.title,e);this.setEditMode(true)})}addNewDashbardInSelect(t,e){const s=new Option(t,e,false,true);$(this.elem_id+" .toolbar .dashboard_select").append(s).trigger("change")}getCardsAjax(t){t=t||"";const e=this.getFiltersFromDB();const s=t.length>0?1:0;const i=[];const a=[];$(this.elem_dom).find(".grid-stack-item:not(.lock-bottom)"+t).each((t,r)=>{r=$(r);const d=r.data("card-options");const o=r.attr("gs-id");const n=d.card_id||r.attr("gs-id");d.gridstack_id=o;if("markdown_content"in d){this.markdown_contents[o]=d.markdown_content}d.apply_filters=e;a.push({card_id:n,force:s,args:d,c_cache_key:d.cache_key||""});i.push({card_el:r,card_id:n,args:d})});if(this.ajax_cards){const t=[];i.forEach(e=>{const i=e.card_el;const a={action:"get_card",dashboard:this.current_name,card_id:e.card_id,force:s,args:e.args,d_cache_key:this.cache_key,c_cache_key:e.args.cache_key||""};if(this.embed){a.embed=1;a.token=this.token;a.entities_id=this.entities_id;a.is_recursive=this.is_recursive}t.push($.get(CFG_GLPI.root_doc+"/ajax/dashboard.php",a).then(t=>{i.children(".grid-stack-item-content").html(t);this.fitNumbers(i);this.animateNumbers(i)},()=>{i.html("<div class='empty-card card-error'><i class='ti ti-alert-triangle'></i></div>")}))});return t}else{const e={dashboard:this.current_name,force:t.length>0?1:0,d_cache_key:this.cache_key,cards:a,action:"get_cards"};if(this.embed){e.embed=1;e.token=this.token;e.entities_id=this.entities_id;e.is_recursive=this.is_recursive}return $.ajax({url:CFG_GLPI.root_doc+"/ajax/dashboard.php",method:"POST",data:e}).then(t=>{$.each(i,(e,s)=>{let i=false;const a=s.card_el;$.each(t,(t,e)=>{if(s.card_id===t){const t=e;i=true;a.children(".grid-stack-item-content").html(t);this.fitNumbers(a);this.animateNumbers(a)}});if(!i){a.html("<div class='empty-card card-error'><i class='ti ti-alert-triangle'></i></div>")}})},()=>{$.each(i,(t,e)=>{const s=e.card_el;s.html("<div class='empty-card card-error'><i class='ti ti-alert-triangle'></i></div>")})})}}initFilters(){if($(this.filters_selector).length===0){return}const t=this.getFiltersFromDB();$.each(t,(e,s)=>{if(Array.isArray(s)&&s.length===0){t[e]=""}});$.get({url:CFG_GLPI.root_doc+"/ajax/dashboard.php",data:{action:"get_dashboard_filters",filters:t}}).then(t=>{$(this.filters_selector).html(t);$(document).trigger("glpiDasbhoardInitFilter");sortable(this.filters_selector,{placeholderClass:"filter-placeholder",orientation:"horizontal"})[0].addEventListener("sortupdate",t=>{const e=$(t.detail.destination.items).filter(this.filters_selector);const s=this.getFiltersFromDB();const i={};$.each(e,t=>{const e=$(t).data("filter-id");i[e]=s[e]});this.setFiltersInDB(i)});sortable(this.filters_selector,"disable")})}getFiltersFromDB(){if(this.embed){return[]}let t;$.ajax({method:"GET",url:CFG_GLPI.root_doc+"/ajax/dashboard.php",async:false,data:{action:"get_filter_data",dashboard:this.current_name},success:function(e){t=e}});return t||{}}setFiltersInDB(t){const e=[];if(this.current_name.length>0){e[this.current_name]=t}$.ajax({method:"POST",url:CFG_GLPI.root_doc+"/ajax/dashboard.php",data:{action:"save_filter_data",dashboard:this.current_name,filters:JSON.stringify(e[this.current_name],(t,e)=>e===undefined?null:e)}})}resizeSelect(){const t=document.querySelector(`${this.elem_id} .dashboard_select`);if(t===null){return}t.addEventListener("change",t=>{const e=document.createElement("select");const s=document.createElement("option");s.textContent=t.target.options[t.target.selectedIndex].text;e.style.cssText+=`\n              visibility: hidden;\n              position: fixed;\n           `;e.appendChild(s);t.target.after(e);const i=e.getBoundingClientRect().width;t.target.style.width=`${i}px`;e.remove()});t.dispatchEvent(new Event("change"))}}window.GLPI.Dashboard.GLPIDashboard=GLPIDashboard;window.GLPIDashboard=GLPIDashboard;export default GLPIDashboard;export{GLPIDashboard};
/**
 * ---------------------------------------------------------------------
 *
 * GLPI - Gestionnaire Libre de Parc Informatique
 *
 * http://glpi-project.org
 *
 * @copyright 2015-2025 Teclib' and contributors.
 * @copyright 2003-2014 by the INDEPNET Development Team.
 * @licence   https://www.gnu.org/licenses/gpl-3.0.html
 *
 * ---------------------------------------------------------------------
 *
 * LICENSE
 *
 * This file is part of GLPI.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 *
 * ---------------------------------------------------------------------
 */
class Screenhot{constructor(){}listenOnFileUpload(e){const t=$(e);const n=new MutationObserver(e=>{e.forEach(e=>{e.removedNodes.forEach(e=>{if(e.nodeType===1&&e.id!==undefined&&e.id.startsWith("doc_uploader_filename")){let n=null;for(let t=0;t<e.children.length;t++){if(e.children[t].name!==undefined&&e.children[t].name.startsWith("_filename")){n=e.children[t];break}}if(n===null){return}t.closest("form").find(".upload-preview-item").each((e,t)=>{if(n.value.endsWith($(t).data("filename"))){$(t).remove()}})}})})});n.observe(e,{childList:true,subtree:true})}isSupported(){if(!window.isSecureContext){return false}const e=navigator.userAgent.toLowerCase();return!e.match(/ipad|iphone|ipod|android/i)}updateCanvas(e,t=null){const n=e.videoWidth??e.width;const i=e.videoHeight??e.height;t.width=n;t.height=i;t.getContext("2d").clearRect(0,0,n,i);t.getContext("2d").drawImage(e,0,0,n,i,0,0,n,i)}async captureScreenshot(){return navigator.mediaDevices.getDisplayMedia({video:true}).then(e=>{const t=e.getVideoTracks()[0];const n=document.createElement("canvas");n.width=t.getSettings().width;n.height=t.getSettings().height;if(typeof ImageCapture!=="undefined"){const e=new ImageCapture(t);return e.grabFrame().then(e=>{this.updateCanvas(e,n);t.stop();return n})}else{const i=document.createElement("video");i.srcObject=e;return new Promise((e,a)=>{try{i.addEventListener("loadeddata",()=>i.play().then(()=>{this.updateCanvas(i,n);t.stop();e(n)}))}catch(e){t.stop();a(e)}})}})}getPreferredBitrate(e){const t=.5;const n=e.getSettings();return n.width*n.height*n.frameRate*t/10}getRecordingCodec(e){const t=["vp9","vp8"];return t.find(t=>MediaRecorder.isTypeSupported(`${e};codecs=${t}`))}startRecording(){return navigator.mediaDevices.getDisplayMedia({video:true,frameRate:10}).then(e=>{const t=e.getVideoTracks()[0];const n=new MediaRecorder(e,{mimeType:`video/webm;codecs=${this.getRecordingCodec("video/webm")}`,videoBitsPerSecond:this.getPreferredBitrate(t)});n.start();return n})}appendPreviewImg(e,t,n,i){const a=$(`\n            <div class="position-relative d-inline-block overflow-hidden upload-preview-item" data-filename="${_.escape(i)}" style="height: ${_.escape(n)}">\n                <button class="btn btn-sm btn-danger position-absolute top-0 start-0" type="button" title="${__("Delete")}">\n                    <i class="ti ti-x"></i>\n                </button>\n            </div>\n        `).appendTo(e);const o=document.createElement("img");o.src=t.toDataURL();o.style.height="200px";o.classList.add("mx-2");a.append(o);const r=e.closest("form");const s=`.fileupload input[name^="_filename"][value$="${CSS.escape(i)}"]`;a.find("button").on("click",()=>{r.find(s).parent().find(".ti-circle-x").click();a.remove()})}appendPreviewVideo(e,t,n,i){const a=$(`\n            <div class="position-relative d-inline-block overflow-hidden upload-preview-item" data-filename="${_.escape(i)}" style="height: ${_.escape(n)}">\n                <button class="btn btn-sm btn-danger position-absolute top-0 start-0" type="button" title="${__("Delete")}">\n                    <i class="ti ti-x"></i>\n                </button>\n            </div>\n        `).appendTo(e);const o=document.createElement("video");o.src=URL.createObjectURL(t);o.style.height="200px";o.classList.add("mx-2");o.controls=true;a.append(o);const r=e.closest("form");const s=`.fileupload input[name^="_filename"][value$="${CSS.escape(i)}"]`;a.find("button").on("click",()=>{r.find(s).parent().find(".ti-circle-x").click();a.remove()})}}export default new Screenhot;